<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Class Dashboard</title>
    <link rel="icon" href="https://cdn.glitch.global/bed65df6-4eb8-4247-853c-e198a6399561/icons%2FBGicon.png">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <button class="search-button" onclick="toggleSearchBox()">üîç</button>
    <div class="menu-icon" onclick="toggleTeacherMode()">‚ò∞</div>
    <div id="header">
        <div id="objective">
            <h3>Objective:</h3>
            <ul id="objectiveList"></ul>
        </div>
        <div id="title">
            <h1 onclick="cycleClass()">Class Name</h1>
            <h2 id="timeRange">Time Range</h2>
            <div id="countdowns"></div>
        </div>
        <div id="date">
            <p><h3>Date:</h3></p>
            <p><span id="currentDate"></span></p>
            <p><span id="currentDay"></span></p>
        </div>
    </div>
    <div id="graph-container"></div>
    <div id="teacher-mode">
        <span class="close-button" onclick="closeTopMenu()">&times;</span>
        <button class="export-button" onclick="exportScores()">Export Scores</button>
        <button class="reset-button" onclick="resetAllStudents()">Reset All</button>
        <div class="spreadsheet">
            <div class="spreadsheet-header"><strong>Student</strong></div>
            <div class="spreadsheet-header"><strong onclick="cycleAttendance()">Attendance</strong></div>
            <div class="spreadsheet-header"><strong onclick="toggleAllCheckboxes('stands')">Stands</strong></div>
            <div class="spreadsheet-header"><strong onclick="toggleAllCheckboxes('ipads')">iPads</strong></div>
            <div class="spreadsheet-header"><strong onclick="toggleAllCheckboxes('returned')">Returned</strong></div>
            <div class="spreadsheet-header"><strong onclick="toggleAllCheckboxes('engagement')">Engagement</strong></div>
            <div class="spreadsheet-header"><strong>Participation</strong></div>
            <div class="spreadsheet-header"><strong>House Points</strong></div>
        </div>
    </div>
    <div id="floating-menu" class="floating-menu"></div>
    <div id="houseshield">
        <div id="points">0</div>
        <div id="student-name"></div>
    </div>
    <div id="overlay">
        <span class="close-button" onclick="closeTopMenu()">&times;</span>
        <h3>Hotkeys</h3>
        <div id="hotkeys"></div>
        <hr>
        <h3>Within Menus:</h3>
        <div id="menuHotkeys"></div>
    </div>

    <script src="studentlist.js"></script>
    <script src="hotkeys.js"></script>
    <script src="stickynote.js"></script>
    <script>
const positiveEffects = [
    'sounds/villager-positive1.mp3',
    'sounds/villager-positive2.mp3',
    'sounds/villager-positive3.mp3',
    'sounds/villager-positive4.mp3'
];

const negativeEffects50Plus = [
    'sounds/villager-negative0.5.mp3',
    'sounds/villager-negative0.9.mp3',
    'sounds/villager-negative1.5.mp3',
    'sounds/villager-negative3.5.mp3'
];

const negativeEffects10to50 = [
    'sounds/villager-negative3.mp3',
    'sounds/villager-negative4.mp3',
    'sounds/villager-negative5.mp3'
];

const negativeEffect0 = 'sounds/villager-negative6.mp3';

const style = document.createElement('style');
style.textContent = `
    input[type="checkbox"]:disabled {
        opacity: 0.5;
    }
`;
document.head.appendChild(style);

function playRandomSound(soundArray) {
    const randomIndex = Math.floor(Math.random() * soundArray.length);
    const audio = new Audio(soundArray[randomIndex]);
    audio.volume = 0.25;
    audio.play();
}

const classes = [
    {
        name: "Production Tech",
        timeRange: "10:45 - 11:35",
        days: ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"],
        startTime: { hours: 10, minutes: 45 },
        endTime: { hours: 11, minutes: 35 },
        students: productionTechStudents,
        teacherModeOrder: productionTechTeacherModeOrder,
        objectivesKey: "productionTechObjectives",
        defaultObjectives: [
            'Review',
            'Group Work',
            'Housekeeping'
        ],
        sampleObjectives: [
            'Review',
            'Hardware',
            'Software',
            'QLab skills',
            'Independent work',
            'Group work',
            'Troubleshooting',
            'Housekeeping'
        ],
        criteria: ['devices', 'engagement', 'review', 'progress']
    },
    {
        name: "MS Band",
        timeRange: "12:40 - 1:30",
        days: ["Monday", "Tuesday", "Wednesday"],
        startTime: { hours: 12, minutes: 40 },
        endTime: { hours: 13, minutes: 30 },
        students: msBandStudents,
        teacherModeOrder: msBandTeacherModeOrder,
        objectivesKey: "msBandObjectives",
        defaultObjectives: [
            'New members!',
            'This year at a glance',
            'Instrument Selection'
        ],
        sampleObjectives: [
            'Review',
            'Music for Winter Concert',
            'The Nutcracker Music',
            'Independent work',
            'Sectionals',
            'Playing Tests',
            'Announcements',
            'Housekeeping'
        ],
        criteria: ['stands', 'ipads', 'returned', 'engagement']
    },
    {
        name: "MS Band ·µÄ·¥¥·µÅ·¥øÀ¢",
        timeRange: "12:40 - 1:30",
        days: ["Thursday"],
        startTime: { hours: 12, minutes: 40 },
        endTime: { hours: 13, minutes: 30 },
        students: msBandThursdayStudents,
        teacherModeOrder: msBandThursdayTeacherModeOrder,
        objectivesKey: "msBandThursdayObjectives",
        defaultObjectives: [
            'First pieces for this year',
            'Individual / sectional work',
            'Detail work'
        ],
        sampleObjectives: [
            'Review',
            'Music for Winter Concert',
            'The Nutcracker Music',
            'Independent work',
            'Sectionals',
            'Playing Tests',
            'Announcements',
            'Housekeeping'
        ],
        criteria: ['stands', 'ipads', 'returned', 'engagement']
    },
    {
        name: "HS Band",
        timeRange: "3:25 - 4:30",
        days: ["Monday", "Tuesday", "Wednesday", "Thursday"],
        startTime: { hours: 15, minutes: 25 },
        endTime: { hours: 16, minutes: 30 },
        students: hsBandStudents,
        teacherModeOrder: hsBandTeacherModeOrder,
        objectivesKey: "hsBandObjectives",
        defaultObjectives: [
            'First pieces for this year',
            'Individual / sectional work',
            'Housekeeping'
        ],
        sampleObjectives: [
            'Review',
            'Music for Winter Concert',
            'The Nutcracker Music',
            'Independent work',
            'Sectionals',
            'Playing Tests',
            'Announcements',
            'Housekeeping'
        ],
        criteria: ['stands', 'ipads', 'returned', 'engagement']
    }
];

let currentClassIndex = 0;
let students = classes[0].students;
let teacherModeOrder = classes[0].teacherModeOrder;
let currentCriteria = classes[0].criteria;
let isObjectiveInputFocused = false;
let isAddingStudent = false;

function getCurrentClass() {
    const now = new Date();
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();
    const currentDay = now.toLocaleDateString('en-US', { weekday: 'long' });
    const currentTime = currentHour * 60 + currentMinute;

    for (let i = 0; i < classes.length; i++) {
        const cls = classes[i];
        if (cls.days.includes(currentDay)) {
            const start = cls.startTime.hours * 60 + cls.startTime.minutes;
            const end = cls.endTime.hours * 60 + cls.endTime.minutes;
            if (currentTime >= start - 30 && currentTime <= start) {
                return i;
            } else if (currentTime >= end - 10 && currentTime <= end) {
                return i;
            }
        }
    }
    return currentClassIndex;
}

function cycleClass() {
    const now = new Date();
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();
    const currentDay = now.toLocaleDateString('en-US', { weekday: 'long' });
    const currentTime = currentHour * 60 + currentMinute;
    
    let nextIndex = currentClassIndex;
    let attempts = 0;
    
    do {
        nextIndex = (nextIndex + 1) % classes.length;
        attempts++;
        const cls = classes[nextIndex];
        if (cls.days.includes(currentDay)) {
            const start = cls.startTime.hours * 60 + cls.startTime.minutes;
            if (currentTime >= start - 30 && currentTime <= start) {
                currentClassIndex = nextIndex;
                updateClassDisplay();
                updateCountdowns();
                return;
            }
        }
    } while (nextIndex !== currentClassIndex && attempts < classes.length);
    
    currentClassIndex = (currentClassIndex + 1) % classes.length;
    updateClassDisplay();
    updateCountdowns();
}

function updateClassDisplay() {
    const cls = classes[currentClassIndex];
    document.querySelector('#title h1').textContent = cls.name;
    document.querySelector('#timeRange').textContent = cls.timeRange;
    students = cls.students;
    teacherModeOrder = cls.teacherModeOrder;
    currentCriteria = cls.criteria;
    loadObjectives(cls.objectivesKey);
    createBars();
    if (document.getElementById('teacher-mode').style.display === 'block') {
        populateStudents();
    }
    updateHotkeysDisplay();
    updateCountdowns();
    loadStickyNotes(); // Add this to load sticky notes for the new class
}

function updateCountdowns() {
    const countdownContainer = document.getElementById('countdowns');
    countdownContainer.innerHTML = ''; // Clear previous countdowns

    const currentClass = classes[currentClassIndex];
    const now = new Date();
    const currentDay = now.toLocaleDateString('en-US', { weekday: 'long' });

    // Exit if the current day is not a class day
    if (!currentClass.days.includes(currentDay)) {
        hasCopiedScores = false;
        hasResetReturned = false;
        return;
    }

    const startTime = new Date(now);
    startTime.setHours(currentClass.startTime.hours, currentClass.startTime.minutes, 0, 0);

    const endTime = new Date(now);
    endTime.setHours(currentClass.endTime.hours, currentClass.endTime.minutes, 0, 0);

    let startDiff = (startTime - now) / 1000;
    let endDiff = (endTime - now) / 1000;

    // Adjust for negative time differences (past midnight)
    if (startDiff < -86400) startDiff += 86400;
    if (endDiff < -86400) endDiff += 86400;

    // Display start countdown (30 minutes before class starts)
    if (startDiff > 0 && startDiff <= 1800) {
        const minutes = Math.floor(startDiff / 60);
        const seconds = Math.floor(startDiff % 60);
        const startDiv = document.createElement('div');
        startDiv.className = 'start-countdown';
        startDiv.textContent = `Class begins in ${minutes}m ${seconds}s`;
        countdownContainer.appendChild(startDiv);
    }
    // Display conclusion countdown (10 to 5 minutes before class ends)
    else if (endDiff <= 600 && endDiff > 300) {
        const conclusionDiff = endDiff - 300;
        const minutes = Math.floor(conclusionDiff / 60);
        const seconds = Math.floor(conclusionDiff % 60);
        const conclusionDiv = document.createElement('div');
        conclusionDiv.className = 'conclusion-countdown';
        conclusionDiv.textContent = `Conclusion: ${minutes}m ${seconds}s`;
        countdownContainer.appendChild(conclusionDiv);
        hasResetReturned = false; // Reset flag when entering conclusion phase
    }
    // Display pack-up countdown (5 minutes or less until class ends)
    else if (endDiff <= 300 && endDiff >= 0) {
        const minutes = Math.floor(endDiff / 60);
        const seconds = Math.floor(endDiff % 60);
        const packupDiv = document.createElement('div');
        packupDiv.className = 'packup-countdown';
        packupDiv.textContent = `‚ô´ Pack up: ${minutes}m ${seconds}s ‚ô´`;
        countdownContainer.appendChild(packupDiv);

        // Reset 'returned' checkboxes only once during pack-up phase
        if (currentClass.criteria.includes('returned') && !hasResetReturned) {
            console.log('Resetting all returned checkboxes for class:', currentClass.name);
            const checkboxIndex = currentClass.criteria.indexOf('returned') + 3;
            const checkboxes = document.querySelectorAll(`.spreadsheet-row .checkbox-container:nth-child(${checkboxIndex}) input[type="checkbox"]`);
            checkboxes.forEach((checkbox, index) => {
                checkbox.checked = false;
                const studentName = teacherModeOrder[index];
                if (studentName) {
                    console.log('Unchecking returned for student:', studentName);
                    syncCheckbox(studentName, checkbox, 'returned');
                }
            });
            hasResetReturned = true; // Prevent further resets
        }
        hasCopiedScores = false; // Allow exporting scores when class ends
    }
    // Export scores when class ends
    else if (endDiff < 0 && endDiff > -2 && !hasCopiedScores) {
        exportScores();
        hasCopiedScores = true;
        hasResetReturned = false; // Reset for next class
    }
}

function loadObjectives(key) {
    const cls = classes.find(c => c.objectivesKey === key);
    const objectives = JSON.parse(localStorage.getItem(key)) || cls.defaultObjectives;
    updateObjectiveList(objectives);
}

function saveObjectives(key) {
    const objectives = Array.from(document.querySelectorAll('#objectiveList li')).map(li => li.textContent);
    localStorage.setItem(key, JSON.stringify(objectives));
}

function updateObjectiveList(objectives) {
    const objectiveList = document.getElementById('objectiveList');
    objectiveList.innerHTML = objectives.map(obj => `<li class="editable" onclick="editObjective(this)">${obj}</li>`).join('');
}

function editObjective(item) {
    const cls = classes[currentClassIndex];
    const currentItem = item.textContent;
    const index = Array.from(item.parentElement.children).indexOf(item);
    const dialog = document.createElement('div');
    dialog.style.position = 'fixed';
    dialog.style.top = '50%';
    dialog.style.left = '50%';
    dialog.style.transform = 'translate(-50%, -50%)';
    dialog.style.backgroundColor = 'white';
    dialog.style.padding = '20px';
    dialog.style.borderRadius = '5px';
    dialog.style.boxShadow = '0 0 10px rgba(0,0,0,0.1)';
    dialog.style.zIndex = '1000';
    dialog.style.textAlign = 'center';
    dialog.style.lineHeight = '1.3';
    dialog.style.width = '400px';

    const suggestions = cls.sampleObjectives.length > 0 
        ? cls.sampleObjectives.map(obj => `
            <a href="#" style="font-size: 0.85em; text-decoration: none; display: block; margin: 2px 0;" 
               onclick="
                   document.querySelector('#objectiveList li:nth-child(${index + 1})').textContent = '${obj}';
                   saveObjectives('${cls.objectivesKey}'); 
                   this.closest('div').remove(); 
                   window.isObjectiveInputFocused = false; 
                   return false;">
                ${obj}
            </a>
          `).join('')
        : '<p style="font-size: 0.85em; color: #999;">No sample objectives available</p>';

    dialog.innerHTML = `
        <h3>Edit Objective</h3>
        <input type="text" id="objectiveInput" value="${currentItem}" style="width: 80%; padding: 5px;" data-original-value="${currentItem}">
        <p style="text-align: left; margin-left: 33px; margin-top: 10px;">
            ${suggestions}
        </p>
        <button onclick="
            const input = document.getElementById('objectiveInput'); 
            if (input.value.trim() !== '') { 
                document.querySelector('#objectiveList li:nth-child(${index + 1})').textContent = input.value.trim(); 
                saveObjectives('${cls.objectivesKey}'); 
            } 
            this.closest('div').remove(); 
            window.isObjectiveInputFocused = false;">
            Save
        </button>
        <button onclick="this.closest('div').remove(); window.isObjectiveInputFocused = false;">Cancel</button>
    `;

    document.body.appendChild(dialog);
    const input = document.getElementById('objectiveInput');
    input.focus();
    input.select();
    window.isObjectiveInputFocused = true;

    input.addEventListener('focus', () => { window.isObjectiveInputFocused = true; });
    input.addEventListener('blur', () => { window.isObjectiveInputFocused = false; });

    const handleKeydown = (event) => {
        if (event.key === 'Escape') {
            dialog.remove();
            window.isObjectiveInputFocused = false;
            document.removeEventListener('keydown', handleKeydown);
        }
    };
    document.addEventListener('keydown', handleKeydown);

    const handleOutsideClick = (event) => {
        if (!dialog.contains(event.target)) {
            dialog.remove();
            window.isObjectiveInputFocused = false;
            document.removeEventListener('click', handleOutsideClick);
        }
    };

    setTimeout(() => {
        document.addEventListener('click', handleOutsideClick);
    }, 0);
}

let menuStack = [];
let currentZIndex = 1000;
const MODES = {
    GLOBAL: 'global',
    SEARCH: 'search',
    HOUSESHIELD: 'houseshield',
    STICKY_NOTE: 'sticky_note' 
};
let currentMode = MODES.GLOBAL;
let currentStudentIndex = -1;
let searchBox = null;
let searchResults = null;
let selectedIndex = 0;
let hasCopiedScores = false;
let hasResetReturned = false;
let isActive = false;
let currentPoints = 0;

function globalKeydownHandler(event) {
    if (event.key === '/' && currentMode === MODES.GLOBAL) {
        event.preventDefault(); // Prevent '/' from propagating
        toggleSearchBox();
        return;
    }
    if (event.key === 'Escape' && menuStack.length > 0) {
        closeTopMenu();
        return;
    }
    switch (currentMode) {
        case MODES.GLOBAL:
            handleGlobalHotkeys(event);
            if (event.ctrlKey && event.key === 'n' && isStickyNoteAllowed()) {
                event.preventDefault();
                createStickyNote();
            }
            break;
        case MODES.SEARCH:
            handleSearchBoxKeys(event);
            break;
        case MODES.HOUSESHIELD:
            handleActiveHouseshield(event);
            break;
        case MODES.STICKY_NOTE:
            break;
    }
}

document.addEventListener('keydown', globalKeydownHandler);

function openMenu(menuId) {
    try {
        const menu = document.getElementById(menuId);
        if (menu && !menuStack.some(m => m.id === menuId)) {
            currentZIndex++;
            menu.style.zIndex = currentZIndex;
            menu.style.display = 'block';
            menuStack.push(menu);
        }
    } catch (error) {
    }
}

function closeTopMenu() {
    if (menuStack.length > 0) {
        const topMenu = menuStack.pop();
        topMenu.style.display = 'none';
        if (topMenu.id === 'search-box') {
            currentMode = MODES.GLOBAL;
            isAddingStudent = false;
            document.removeEventListener('click', handleSearchOutsideClick);
            if (searchBox) {
                searchBox.remove();
                searchBox = null;
                searchResults = null;
            }
        } else if (topMenu.id === 'houseshield') {
            deactivateHouseshield();
        } else if (topMenu.id === 'floating-menu') {
            resetBarHighlights();
        }
        if (menuStack.length === 0) {
            currentMode = MODES.GLOBAL;
        }
        document.activeElement.blur();
    }
}

function closeSpecificMenu(menuId) {
    const menuIndex = menuStack.findIndex(menu => menu.id === menuId);
    if (menuIndex !== -1) {
        const menu = menuStack.splice(menuIndex, 1)[0];
        menu.style.display = 'none';
        if (menu.id === 'search-box') {
            currentMode = MODES.GLOBAL;
            isAddingStudent = false;
        } else if (menu.id === 'houseshield') {
            deactivateHouseshield();
        } else if (menu.id === 'floating-menu') {
            resetBarHighlights();
        }
        if (menuStack.length === 0) {
            currentMode = MODES.GLOBAL;
        }
    }
}

function populateStudents() {
    const spreadsheet = document.querySelector('.spreadsheet');
    const isProductionTech = classes[currentClassIndex].name === "Production Tech";
    spreadsheet.innerHTML = `
        <div class="spreadsheet-header"><strong>Student</strong></div>
        <div class="spreadsheet-header"><strong onclick="cycleAttendance()">Attendance</strong></div>
        <div class="spreadsheet-header"><strong onclick="toggleAllCheckboxes('${currentCriteria[0]}')">${isProductionTech ? 'Devices' : 'Stands'}</strong></div>
        <div class="spreadsheet-header"><strong onclick="toggleAllCheckboxes('${currentCriteria[1]}')">${isProductionTech ? 'Engagement' : 'iPads'}</strong></div>
        <div class="spreadsheet-header"><strong onclick="toggleAllCheckboxes('${currentCriteria[2]}')">${isProductionTech ? 'Review' : 'Returned'}</strong></div>
        <div class="spreadsheet-header"><strong onclick="toggleAllCheckboxes('${currentCriteria[3]}')">${isProductionTech ? 'Progress' : 'Engagement'}</strong></div>
        <div class="spreadsheet-header"><strong>Participation</strong></div>
        <div class="spreadsheet-header"><strong>House Points</strong></div>
    `;
    teacherModeOrder.forEach(name => {
        const student = students.find(s => s.name === name);
        const isAbsent = student.attendance === 'Absent';
        const row = document.createElement('div');
        row.className = 'spreadsheet-row';
        row.dataset.studentName = student.name;
        row.innerHTML = `
            <div class="student-name">${student.name}</div>
            <div class="attendance-dropdown">
                <select onchange="syncAttendance('${student.name}', this)">
                    <option value="Absent" ${student.attendance === 'Absent' ? 'selected' : ''}>Absent</option>
                    <option value="Present" ${student.attendance === 'Present' ? 'selected' : ''}>Present</option>
                    <option value="Tardy" ${student.attendance === 'Tardy' ? 'selected' : ''}>Tardy</option>
                </select>
            </div>
            <div class="checkbox-container">
                <input type="checkbox" ${student[currentCriteria[0]] ? 'checked' : ''} ${isAbsent ? 'disabled' : ''} onchange="syncCheckbox('${student.name}', this, '${currentCriteria[0]}')">
            </div>
            <div class="checkbox-container">
                <input type="checkbox" ${student[currentCriteria[1]] ? 'checked' : ''} ${isAbsent ? 'disabled' : ''} onchange="syncCheckbox('${student.name}', this, '${currentCriteria[1]}')">
            </div>
            <div class="checkbox-container">
                <input type="checkbox" ${student[currentCriteria[2]] ? 'checked' : ''} ${isAbsent ? 'disabled' : ''} onchange="syncCheckbox('${student.name}', this, '${currentCriteria[2]}')">
            </div>
            <div class="checkbox-container">
                <input type="checkbox" ${student[currentCriteria[3]] ? 'checked' : ''} ${isAbsent ? 'disabled' : ''} onchange="syncCheckbox('${student.name}', this, '${currentCriteria[3]}')">
            </div>
            <div class="stepper">
                <button onclick="updateScore('${student.name}', -10)">-</button>
                <span class="score">${student.score === 'EX' ? 'EX' : student.score + '%'}</span>
                <button onclick="updateScore('${student.name}', 10)">+</button>
            </div>
            <div class="stepper">
                <button onclick="updateHousePoints('${student.name}', -10)">-</button>
                <span>${student.housePoints}</span>
                <button onclick="updateHousePoints('${student.name}', 10)">+</button>
            </div>
        `;
        spreadsheet.appendChild(row);
    });
}

function updateHousePoints(name, change) {
    const student = students.find(s => s.name === name);
    if (student) {
        student.housePoints += change;
        updateScoreDisplay(student);
        const housePointsSpan = document.querySelector(`.spreadsheet-row[data-student-name="${student.name}"] .stepper:last-child span`);
        if (housePointsSpan) {
            housePointsSpan.textContent = student.housePoints;
        }
        updateFloatingMenu(student);
        updateBarGraph(student);
        const housePointsElement = document.querySelector(`#bar-${CSS.escape(student.name)} .house-points`);
        if (housePointsElement) {
            const houseInfo = masterList.find(s => s.name === student.name);
            const houseColor = getHouseColor(houseInfo.house);
            housePointsElement.style.transition = 'background-color 1.0s ease, backdrop-filter 1.0s ease';
            housePointsElement.style.backgroundColor = `${houseColor}CC`;
            setTimeout(() => {
                housePointsElement.style.backgroundColor = `${houseColor}66`;
            }, 500);
        }
    }
}

function getHouseColor(house) {
    switch (house.toLowerCase()) {
        case 'red': return '#FF3333';
        case 'blue': return '#3366FF';
        case 'green': return '#00A300';
        case 'yellow': return '#FFCC00';
        default: return '#808080';
    }
}

function toggleTeacherMode() {
    const teacherMode = document.getElementById('teacher-mode');
    if (teacherMode.style.display === 'block') {
        closeSpecificMenu('teacher-mode');
    } else {
        openMenu('teacher-mode');
        populateStudents();
    }
}

function enterTeacherMode() {
    openMenu('teacher-mode');
    populateStudents();
}

function exitTeacherMode() {
    closeSpecificMenu('teacher-mode');
}

function syncAttendance(name, select) {
    const student = students.find(s => s.name === name);
    if (student) {
        student.attendance = select.value;
        calculateScore(student);
        updateScoreDisplay(student);
        updateTardyLabel(student);
        updateBarGraph(student);
        const teacherRow = document.querySelector(`.spreadsheet-row[data-student-name="${student.name}"]`);
        if (teacherRow) {
            const attendanceSelect = teacherRow.querySelector('.attendance-dropdown select');
            if (attendanceSelect) {
                attendanceSelect.value = student.attendance;
            }
            // Update checkbox disabled state in teacher mode
            const checkboxes = teacherRow.querySelectorAll('.checkbox-container input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.disabled = student.attendance === 'Absent';
            });
        }
        // Update checkbox disabled state in floating menu
        const floatingMenu = document.getElementById('floating-menu');
        if (floatingMenu && floatingMenu.style.display === 'block' && floatingMenu.querySelector('h3').textContent === student.name) {
            const floatingCheckboxes = floatingMenu.querySelectorAll('input[type="checkbox"]');
            floatingCheckboxes.forEach(checkbox => {
                checkbox.disabled = student.attendance === 'Absent';
            });
        }
        updateFloatingMenu(student);
    }
}

function syncCheckbox(name, checkbox, type) {
    const student = students.find(s => s.name === name);
    if (student) {
        student[type] = checkbox.checked;
        calculateScore(student);
        updateScoreDisplay(student);
        updateBarGraph(student);
        updateTeacherMenu(student);
        updateFloatingMenu(student);
    }
}

function updateScore(name, change) {
    const student = students.find(s => s.name === name);
    if (student && student.score !== 'EX') {
        const newScore = Math.max(0, Math.min(100, student.score + change));
        if (newScore !== student.score) {
            student.manualAdjustment = (student.manualAdjustment || 0) + (newScore - student.score);
            student.score = newScore;
            const bar = document.getElementById(`bar-${name}`);
            bar.style.height = `${student.score}%`;
            bar.querySelector('.bar-label').innerHTML = `${name}<br>${student.score}%`;
            bar.style.setProperty('--flash-color', change > 0 ? 'rgba(46, 204, 113, 0.6)' : 'rgba(231, 76, 60, 0.6)');
            bar.classList.remove('flash-animation');
            void bar.offsetWidth;
            bar.classList.add('flash-animation');
            updateScoreDisplay(student);
            updateFloatingMenu(student);
            if (change > 0) {
                playRandomSound(positiveEffects);
            } else {
                if (newScore === 0) {
                    const audio = new Audio(negativeEffect0);
                    audio.play();
                } else if (newScore >= 50) {
                    playRandomSound(negativeEffects50Plus);
                } else if (newScore >= 10) {
                    playRandomSound(negativeEffects10to50);
                }
            }
        }
    }
}

function calculateScore(student) {
    if (student.attendance === 'Absent') {
        student.score = 'EX';
    } else {
        let baseScore = 60;
        if (student.attendance === 'Tardy') baseScore -= 20;
        if (student[currentCriteria[0]]) baseScore += 10;
        if (student[currentCriteria[1]]) baseScore += 10;
        if (student[currentCriteria[2]]) baseScore += 10;
        if (student[currentCriteria[3]]) baseScore += 10;
        let manualAdjustment = student.manualAdjustment || 0;
        student.score = Math.max(0, Math.min(100, baseScore + manualAdjustment));
    }
}

function updateScoreDisplay(student) {
    const bar = document.getElementById(`bar-${student.name}`);
    if (bar) {
        const isStudentsBirthday = isBirthday(student.birthdate);
        if (isStudentsBirthday) {
            bar.classList.add('bdaycolorful');
        } else {
            bar.classList.remove('bdaycolorful');
        }
        bar.style.transition = 'height 0.3s ease-in-out, opacity 0.5s ease';
        const houseInfo = masterList.find(s => s.name === student.name);
        const houseColor = houseInfo ? getHouseColor(houseInfo.house) : '#808080';
        if (student.score === 'EX') {
            bar.classList.add('ex-score');
            bar.style.height = '0%';
            bar.innerHTML = `
                <div class="bar-label">
                    <div class="main-labels">
                        <span>${student.name}</span>
                        <span class="score">EX</span>
                    </div>
                    <div class="secondary-labels">
                        ${student.attendance === 'Tardy' ? '<div class="tardy-label">Tardy</div>' : ''}
                        ${student.housePoints !== 0 ? `<div class="house-points" style="background-color: ${houseColor}66">${student.housePoints > 0 ? '+' : ''}${student.housePoints}</div>` : ''}
                    </div>
                </div>
            `;
        } else {
            bar.classList.remove('ex-score');
            bar.style.height = `${student.score}%`;
            bar.innerHTML = `
                <div class="value-label">${student.score}%</div>
                <div class="bar-label">
                    <div class="main-labels">
                        <span>${student.name}</span>
                        <span class="score">${student.score}%</span>
                    </div>
                    <div class="secondary-labels">
                        ${student.attendance === 'Tardy' ? '<div class="tardy-label">Tardy</div>' : ''}
                        ${student.housePoints !== 0 ? `<div class="house-points" style="background-color: ${houseColor}66">${student.housePoints > 0 ? '+' : ''}${student.housePoints}</div>` : ''}
                    </div>
                </div>
            `;
        }
        const scoreSpan = bar.querySelector('.score');
        if (scoreSpan) {
            scoreSpan.removeAttribute('style');
        }
        updateTeacherMenu(student);
        updateFloatingMenu(student);
        const participationSpan = document.querySelector(`.spreadsheet-row[data-student-name="${student.name}"] .stepper span`);
        if (participationSpan) {
            participationSpan.textContent = student.score === 'EX' ? 'EX' : `${student.score}%`;
        }
    }
}

window.addEventListener('resize', () => {
    students.forEach(student => updateScoreDisplay(student));
});

function updateTeacherMenu(student) {
    const participationSpan = document.querySelector(`.spreadsheet-row[data-student-name="${student.name}"] .stepper span`);
    if (participationSpan) {
        participationSpan.textContent = student.score === 'EX' ? 'EX' : `${student.score}%`;
    }
    const housePointsSpan = document.querySelector(`.spreadsheet-row[data-student-name="${student.name}"] .stepper:last-child span`);
    if (housePointsSpan) {
        housePointsSpan.textContent = student.housePoints;
    }
}

function updateFloatingMenu(student) {
    const floatingMenu = document.getElementById('floating-menu');
    if (floatingMenu && floatingMenu.style.display === 'block') {
        const isProductionTech = classes[currentClassIndex].name === "Production Tech";
        const attendanceSelect = floatingMenu.querySelector('select');
        if (attendanceSelect) {
            attendanceSelect.value = student.attendance;
        }
        const checkboxes = floatingMenu.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            const property = checkbox.id.replace('checkbox-', '');
            checkbox.checked = student[property];
        });
        const participationSpan = floatingMenu.querySelector('.stepper:first-of-type span');
        if (participationSpan) {
            participationSpan.textContent = student.score === 'EX' ? 'EX' : `${student.score}%`;
        }
        const housePointsSpan = floatingMenu.querySelector('.stepper:last-of-type span:nth-child(3)');
        if (housePointsSpan) {
            housePointsSpan.textContent = student.housePoints > 0 ? `+${student.housePoints}` : student.housePoints;
        }
    }
}

function updateTardyLabel(student) {
    const bar = document.getElementById(`bar-${student.name}`);
    if (bar) {
        const secondaryLabels = bar.querySelector('.secondary-labels');
        if (secondaryLabels) {
            const tardyLabel = secondaryLabels.querySelector('.tardy-label');
            if (student.attendance === 'Tardy') {
                if (!tardyLabel) {
                    const newTardyLabel = document.createElement('div');
                    newTardyLabel.className = 'tardy-label';
                    newTardyLabel.textContent = 'Tardy';
                    secondaryLabels.appendChild(newTardyLabel);
                }
            } else {
                if (tardyLabel) {
                    tardyLabel.remove();
                }
            }
        }
    }
}

function createBars() {
    const container = document.getElementById('graph-container');
    container.innerHTML = '';
    students.forEach(student => {
        const bar = document.createElement('div');
        bar.className = 'bar';
        const isBday = isBirthday(student.birthdate);
        if (isBday) {
            bar.classList.add('bdaycolorful');
        }
        if (student.score === 'EX') {
            bar.classList.add('ex-score');
        }
        bar.style.transition = 'height 0.3s ease-in-out, opacity 0.5s ease';
        bar.style.height = student.score === 'EX' ? '0%' : `${student.score}%`;
        bar.id = `bar-${student.name}`;
        bar.dataset.studentName = student.name;
        const houseInfo = masterList.find(s => s.name === student.name);
        const houseColor = houseInfo ? getHouseColor(houseInfo.house) : '#808080';
        bar.innerHTML = `
            ${student.score !== 'EX' ? `<div class="value-label">${student.score}%</div>` : ''}
            <div class="bar-label">
                <div class="main-labels">
                    <span ${isBday ? 'class="colorful"' : ''}>${student.name}</span>
                    <span class="score">${student.score === 'EX' ? 'EX' : `${student.score}%`}</span>
                </div>
                <div class="secondary-labels">
                    ${student.attendance === 'Tardy' ? '<div class="tardy-label">Tardy</div>' : ''}
                    ${student.housePoints !== 0 ? `<div class="house-points" style="background-color: ${houseColor}66">${student.housePoints > 0 ? '+' : ''}${student.housePoints}</div>` : ''}
                </div>
            </div>
        `;
        bar.addEventListener('mouseover', () => highlightBar(student.name));
        bar.addEventListener('mouseout', () => resetBarHighlights());
        bar.addEventListener('click', (event) => {
            const nameSpan = event.target.closest('.main-labels span:first-child');
            const scoreSpan = event.target.closest('.main-labels span.score');
            const tardyLabel = event.target.closest('.secondary-labels .tardy-label');
            const housePoints = event.target.closest('.secondary-labels .house-points');
            const isNarrowView = window.matchMedia('(max-width: 1200px)').matches;
            if (nameSpan || (!isNarrowView && scoreSpan)) {
                cycleAttendanceForStudent(student);
            } else if (isNarrowView && (scoreSpan || tardyLabel || housePoints)) {
                showFloatingMenu(event, student.name);
            } else if (!nameSpan && !scoreSpan && !tardyLabel && !housePoints) {
                showFloatingMenu(event, student.name);
            }
        });
        container.appendChild(bar);
    });
}

function isBirthday(birthdate) {
    if (!birthdate) return false;
    const today = new Date();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const todayFormatted = `${month}-${day}`;
    const [, birthMonth, birthDay] = birthdate.split('-');
    return `${birthMonth}-${birthDay}` === todayFormatted;
}

function highlightBar(name) {
    document.querySelectorAll('.bar, .bar-label').forEach(el => {
        if (el.id === `bar-${name}` || el.parentElement.id === `bar-${name}`) {
            el.style.opacity = '1';
            const nameSpan = el.querySelector('.main-labels span:first-child');
            if (nameSpan) {
                nameSpan.style.fontWeight = 'bold';
            }
        } else {
            el.style.opacity = '0.7';
        }
    });
}

function resetBarHighlights() {
    document.querySelectorAll('.bar, .bar-label').forEach(el => {
        el.style.opacity = '1';
        const nameSpan = el.querySelector('.main-labels span:first-child');
        if (nameSpan) {
            nameSpan.style.fontWeight = 'normal';
            nameSpan.style.textDecoration = 'none';
        }
    });
}

function updateBarGraph(student) {
    const bar = document.getElementById(`bar-${student.name}`);
    if (bar) {
        const housePointsElement = bar.querySelector('.house-points');
        const secondaryLabels = bar.querySelector('.secondary-labels');
        if (housePointsElement) {
            housePointsElement.remove();
        }
        if (student.housePoints !== 0 && secondaryLabels) {
            const houseInfo = masterList.find(s => s.name === student.name);
            const houseColor = houseInfo ? getHouseColor(houseInfo.house) : '#808080';
            const newHousePointsElement = document.createElement('div');
            newHousePointsElement.className = 'house-points';
            newHousePointsElement.textContent = student.housePoints > 0 ? `+${student.housePoints}` : student.housePoints;
            newHousePointsElement.style.backgroundColor = `${houseColor}66`;
            secondaryLabels.appendChild(newHousePointsElement);
            newHousePointsElement.style.transition = 'background-color 1.0s ease, backdrop-filter 1.0s ease';
            newHousePointsElement.style.backgroundColor = `${houseColor}CC`;
            setTimeout(() => {
                newHousePointsElement.style.backgroundColor = `${houseColor}66`;
            }, 500);
        }
        updateFloatingMenu(student);
    }
}

function navigateStudentMenu(direction) {
    if (currentStudentIndex === -1) {
        currentStudentIndex = direction > 0 ? 0 : students.length - 1;
    } else {
        currentStudentIndex = (currentStudentIndex + direction + students.length) % students.length;
    }
    const newStudent = students[currentStudentIndex];
    resetBarHighlights();
    showFloatingMenu(null, newStudent.name);
}

function showFloatingMenu(event, studentName) {
    const floatingMenu = document.getElementById('floating-menu');
    const student = students.find(s => s.name === studentName);
    const isProductionTech = classes[currentClassIndex].name === "Production Tech";
    currentStudentIndex = students.findIndex(s => s.name === studentName);
    if (currentStudentIndex === -1) {
        return;
    }
    const isAbsent = student.attendance === 'Absent';
    floatingMenu.innerHTML = `
        <span class="close-button" onclick="closeTopMenu()">&times;</span>
        <h3 onclick="cycleAttendanceForStudent(students[${currentStudentIndex}])">${student.name}</h3>
        <select onchange="syncAttendance('${student.name}', this)">
            <option value="Absent" ${student.attendance === 'Absent' ? 'selected' : ''}>Absent</option>
            <option value="Present" ${student.attendance === 'Present' ? 'selected' : ''}>Present</option>
            <option value="Tardy" ${student.attendance === 'Tardy' ? 'selected' : ''}>Tardy</option>
        </select>
        <label><input type="checkbox" id="checkbox-${currentCriteria[0]}" ${student[currentCriteria[0]] ? 'checked' : ''} ${isAbsent ? 'disabled' : ''} onchange="syncCheckbox('${student.name}', this, '${currentCriteria[0]}')"> ${isProductionTech ? 'Devices' : 'Stands'}</label>
        <label><input type="checkbox" id="checkbox-${currentCriteria[1]}" ${student[currentCriteria[1]] ? 'checked' : ''} ${isAbsent ? 'disabled' : ''} onchange="syncCheckbox('${student.name}', this, '${currentCriteria[1]}')"> ${isProductionTech ? 'Engagement' : 'iPads'}</label>
        <label><input type="checkbox" id="checkbox-${currentCriteria[2]}" ${student[currentCriteria[2]] ? 'checked' : ''} ${isAbsent ? 'disabled' : ''} onchange="syncCheckbox('${student.name}', this, '${currentCriteria[2]}')"> ${isProductionTech ? 'Review' : 'Returned'}</label>
        <label><input type="checkbox" id="checkbox-${currentCriteria[3]}" ${student[currentCriteria[3]] ? 'checked' : ''} ${isAbsent ? 'disabled' : ''} onchange="syncCheckbox('${student.name}', this, '${currentCriteria[3]}')"> ${isProductionTech ? 'Progress' : 'Engagement'}</label>
        <div class="stepper">
            <button onclick="updateScore('${student.name}', -10)">-</button>
            <span class="score">${student.score === 'EX' ? 'EX' : `${student.score}%`}</span>
            <button onclick="updateScore('${student.name}', 10)">+</button>
        </div>
        <div class="stepper">
            <span>House Points</span>
            <button onclick="updateHousePoints('${student.name}', -10)">-</button>
            <span>${student.housePoints > 0 ? '+' : ''}${student.housePoints}</span>
            <button onclick="updateHousePoints('${student.name}', 10)">+</button>
        </div>
        <button onclick="closeFloatingMenu()">Close</button>
    `;
    const menuWidth = floatingMenu.offsetWidth;
    const menuHeight = floatingMenu.offsetHeight;
    floatingMenu.style.left = `50%`;
    floatingMenu.style.top = `50%`;
    openMenu('floating-menu');
    highlightBar(student.name);
}

function closeFloatingMenu() {
    closeSpecificMenu('floating-menu');
    resetBarHighlights();
}

function updateDateTime() {
    const now = new Date();
    document.getElementById('currentDate').textContent = now.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    document.getElementById('currentDay').textContent = now.toLocaleDateString('en-US', { weekday: 'long' });
}

function cycleAttendance() {
    const attendanceOptions = ['Absent', 'Present', 'Tardy'];
    const currentIndex = attendanceOptions.indexOf(students[0].attendance);
    const nextIndex = (currentIndex + 1) % attendanceOptions.length;
    const nextAttendance = attendanceOptions[nextIndex];
    students.forEach(student => {
        student.attendance = nextAttendance;
        calculateScore(student);
        updateScoreDisplay(student);
        updateTardyLabel(student);
        updateBarGraph(student);
        const teacherRow = document.querySelector(`.spreadsheet-row[data-student-name="${student.name}"]`);
        if (teacherRow) {
            const attendanceSelect = teacherRow.querySelector('.attendance-dropdown select');
            if (attendanceSelect) {
                attendanceSelect.value = student.attendance;
            }
            // Update checkbox disabled state in teacher mode
            const checkboxes = teacherRow.querySelectorAll('.checkbox-container input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.disabled = student.attendance === 'Absent';
            });
        }
        // Update floating menu if open for this student
        const floatingMenu = document.getElementById('floating-menu');
        if (floatingMenu && floatingMenu.style.display === 'block' && floatingMenu.querySelector('h3').textContent === student.name) {
            const floatingCheckboxes = floatingMenu.querySelectorAll('input[type="checkbox"]');
            floatingCheckboxes.forEach(checkbox => {
                checkbox.disabled = student.attendance === 'Absent';
            });
            updateFloatingMenu(student);
        }
    });
    document.querySelectorAll('.attendance-dropdown select').forEach(select => {
        select.value = nextAttendance;
    });
}

function toggleAllCheckboxes(type) {
    const checkboxes = document.querySelectorAll(`.spreadsheet-row .checkbox-container:nth-child(${currentCriteria.indexOf(type) + 3}) input[type="checkbox"]`);
    const anyUnchecked = Array.from(checkboxes).some(cb => !cb.checked);
    checkboxes.forEach((checkbox, index) => {
        checkbox.checked = anyUnchecked;
        const studentName = teacherModeOrder[index];
        if (studentName) {
            syncCheckbox(studentName, checkbox, type);
        }
    });
}

function addStudent(name) {
    const masterStudent = masterList.find(s => s.name === name);
    if (masterStudent && !students.some(s => s.name === name)) {
        const newStudent = {
            name: masterStudent.name,
            birthdate: masterStudent.birthdate,
            house: masterStudent.house,
            attendance: 'Present',
            [currentCriteria[0]]: true,
            [currentCriteria[1]]: true,
            [currentCriteria[2]]: true,
            [currentCriteria[3]]: true,
            score: 100,
            housePoints: 0,
            manualAdjustment: 0,
            isAdditional: true
        };
        students.push(newStudent);
        teacherModeOrder.push(name);
        createBars();
        const newBar = document.getElementById(`bar-${newStudent.name}`);
        if (newBar) {
            newBar.style.height = '0%';
            setTimeout(() => {
                newBar.style.transition = 'height 0.3s ease-in-out, opacity 0.5s ease';
                newBar.style.height = `${newStudent.score}%`;
                newBar.style.setProperty('--flash-color', 'rgba(46, 204, 113, 0.6)');
                newBar.classList.remove('flash-animation');
                void newBar.offsetWidth;
                newBar.classList.add('flash-animation');
            }, 10);
        }
        if (document.getElementById('teacher-mode').style.display === 'block') {
            populateStudents();
        }
        closeSearchBox();
    }
}

function createSearchBox() {
    try {
        if (!document.getElementById('search-box')) {
            searchBox = document.createElement('div');
            searchBox.id = 'search-box';
            searchBox.style.position = 'fixed';
            searchBox.style.top = '50%';
            searchBox.style.left = '50%';
            searchBox.style.transform = 'translate(-50%, -50%)';
            searchBox.style.backgroundColor = 'white';
            searchBox.style.padding = '20px';
            searchBox.style.borderRadius = '5px';
            searchBox.style.boxShadow = '0 0 10px rgba(0, 0, 0, 0.1)';
            searchBox.style.zIndex = '1000';
            searchBox.style.display = 'block';
            searchBox.innerHTML = `
                <input type="text" id="search-input" placeholder="${isAddingStudent ? 'Add student' : 'Type student name...'}" autocomplete="off">
                <div id="search-results"></div>
                ${!isAddingStudent ? '<div id="add-student-option" style="font-size: smaller; color: gray; cursor: pointer;" onmouseover="this.style.textDecoration=\'underline\';" onmouseout="this.style.textDecoration=\'none\';" onclick="toggleAddStudentMode()">Add student</div>' : ''}
            `;
            document.body.appendChild(searchBox);
            
            searchBox.style.display = 'none';
            void searchBox.offsetWidth;
            searchBox.style.display = 'block';
            
            searchResults = document.getElementById('search-results');
            if (!searchResults) {
                throw new Error('Search results element not found');
            }
            
            const searchInput = document.getElementById('search-input');
            if (!searchInput) {
                throw new Error('Search input element not found');
            }
            
            searchInput.value = ''; // Clear any existing input
            searchInput.focus();
            
            openMenu('search-box');
            currentMode = MODES.SEARCH;

            searchInput.addEventListener('input', () => {
                try {
                    updateSearchResults(searchInput.value);
                } catch (e) {
                }
            });

            setTimeout(() => {
                document.addEventListener('click', handleSearchOutsideClick);
            }, 0);
        }
    } catch (error) {
    }
}

function toggleAddStudentMode() {
    closeSearchBox();
    isAddingStudent = true;
    createSearchBox();
}

function toggleSearchBox() {
    const searchBox = document.getElementById('search-box');
    if (searchBox) {
        closeSearchBox();
    } else {
        isAddingStudent = false;
        createSearchBox();
    }
}

function handleSearchOutsideClick(event) {
    const searchBox = document.getElementById('search-box');
    if (searchBox && !searchBox.contains(event.target) && !event.target.closest('.search-button')) {
        closeSearchBox();
        document.removeEventListener('click', handleSearchOutsideClick);
    }
}

function updateSearchResults(query) {
    let matchingStudents;
    searchResults.innerHTML = '';
    selectedIndex = 0;
    if (query.trim() === '') {
        const addStudentOption = document.getElementById('add-student-option');
        if (addStudentOption) {
            addStudentOption.style.display = !isAddingStudent ? 'block' : 'none';
        }
        return;
    }
    if (isAddingStudent) {
        const currentStudentNames = students.map(s => s.name);
        matchingStudents = masterList
            .filter(student => !currentStudentNames.includes(student.name))
            .filter(student => student.name.toLowerCase().includes(query.toLowerCase()));
    } else {
        matchingStudents = students.filter(student => 
            student.name.toLowerCase().includes(query.toLowerCase())
        );
    }
    matchingStudents.forEach((student, index) => {
        const result = document.createElement('div');
        result.textContent = student.name;
        result.className = index === 0 ? 'selected' : '';
        result.onclick = () => {
            if (isAddingStudent) {
                addStudent(student.name);
            } else {
                showFloatingMenu(null, student.name);
                closeSearchBox();
            }
        };
        searchResults.appendChild(result);
    });
    const addStudentOption = document.getElementById('add-student-option');
    if (addStudentOption) {
        addStudentOption.style.display = 'none';
    }
}

function closeSearchBox() {
    try {
        const searchBox = document.getElementById('search-box');
        if (searchBox) {
            document.body.removeChild(searchBox);
            closeSpecificMenu('search-box');
            document.removeEventListener('click', handleSearchOutsideClick);
            isAddingStudent = false;
            currentMode = MODES.GLOBAL;
            selectedIndex = 0;
            searchBox = null;
            searchResults = null;
        }
    } catch (error) {
    }
}

function toggleHouseShield() {
    const houseshield = document.getElementById('houseshield');
    if (houseshield.classList.contains('active')) {
        deactivateHouseshield();
    } else {
        activateHouseshield();
    }
}

function activateHouseshield() {
    const houseshield = document.getElementById('houseshield');
    const points = document.getElementById('points');
    const studentName = document.getElementById('student-name');
    currentZIndex++;
    houseshield.style.zIndex = currentZIndex;
    if (currentStudentIndex === -1) {
        const floatingMenu = document.getElementById('floating-menu');
        if (floatingMenu && floatingMenu.style.display === 'block') {
            const currentStudentName = floatingMenu.querySelector('h3').textContent;
            currentStudentIndex = students.findIndex(s => s.name === currentStudentName);
        }
    }
    if (currentStudentIndex === -1 || currentStudentIndex >= students.length) {
        return;
    }
    const student = students[currentStudentIndex];
    const houseInfo = masterList.find(s => s.name === student.name);
    if (!houseInfo) {
        return;
    }
    if (houseshield) {
        houseshield.style.backgroundImage = `url('https://cdn.glitch.global/bed65df6-4eb8-4247-853c-e198a6399561/${houseInfo.house.toLowerCase()}.png')`;
        houseshield.style.display = 'block';
        void houseshield.offsetWidth;
        houseshield.classList.add('active');
    }
    if (points) {
        points.classList.add('active');
    }
    if (studentName) {
        studentName.textContent = student.name;
        studentName.classList.add('active');
    }
    currentPoints = student.housePoints;
    updatePoints();
    isActive = true;
    currentMode = MODES.HOUSESHIELD;
    openMenu('houseshield');
}

function updatePoints() {
    const points = document.getElementById('points');
    if (points) {
        points.textContent = currentPoints > 0 ? `+${currentPoints}` : currentPoints;
    }
}

function applyHousePointsChange() {
    const student = students[currentStudentIndex];
    const change = currentPoints - student.housePoints;
    updateHousePoints(student.name, change);
    closeFloatingMenu();
    deactivateHouseshield();
}

function deactivateHouseshield() {
    const houseshield = document.getElementById('houseshield');
    const points = document.getElementById('points');
    const studentName = document.getElementById('student-name');
    if (houseshield) {
        houseshield.style.display = 'block';
        houseshield.classList.add('active');
        void houseshield.offsetWidth;
        houseshield.classList.remove('active');
        const handler = (event) => {
            if (event.propertyName === 'opacity' && !houseshield.classList.contains('active')) {
                houseshield.style.display = 'none';
                houseshield.removeEventListener('transitionend', handler);
            }
        };
        houseshield.addEventListener('transitionend', handler);
        setTimeout(() => {
            if (!houseshield.classList.contains('active') && houseshield.style.display !== 'none') {
                houseshield.style.display = 'none';
                houseshield.removeEventListener('transitionend', handler);
            }
        }, 600);
    }
    if (points) {
        points.classList.remove('active');
    }
    if (studentName) {
        studentName.classList.remove('active');
    }
    isActive = false;
    closeSpecificMenu('houseshield');
    const floatingMenu = document.getElementById('floating-menu');
    if (menuStack.length === 0 || (menuStack.length === 1 && menuStack[0] === floatingMenu)) {
        currentMode = MODES.GLOBAL;
    }
}

function cycleAttendanceForStudent(student) {
    const attendanceOptions = ['Present', 'Tardy', 'Absent'];
    const currentIndex = attendanceOptions.indexOf(student.attendance);
    const nextIndex = (currentIndex + 1) % attendanceOptions.length;
    student.attendance = attendanceOptions[nextIndex];
    syncAttendance(student.name, { value: student.attendance });
}

function toggleCheckboxForStudent(student, property) {
    student[property] = !student[property];
    syncCheckbox(student.name, { checked: student[property] }, property);
}

function toggleOverlay() {
    const overlay = document.getElementById('overlay');
    if (overlay.style.display === 'block') {
        closeTopMenu();
    } else {
        openMenu('overlay');
    }
}

function preloadHouseImages() {
    const houses = ['red', 'blue', 'green', 'yellow'];
    houses.forEach(house => {
        const img = new Image();
        img.src = `https://cdn.glitch.global/bed65df6-4eb8-4247-853c-e198a6399561/${house}.png`;
    });
}


document.addEventListener('click', function(event) {
    if (menuStack.length === 0) return;

    const topMenu = menuStack[menuStack.length - 1];
    const isClickOnMenuIcon = event.target.closest('.menu-icon');
    const isClickOnBar = event.target.closest('.bar');

    const exceptions = {
        'teacher-mode': isClickOnMenuIcon,
        'floating-menu': isClickOnBar || isClickOnMenuIcon,
        'houseshield': isClickOnMenuIcon,
        'search-box': isClickOnMenuIcon || event.target.closest('.search-button'),
        'overlay': isClickOnMenuIcon
    };

    if (!topMenu.contains(event.target) && !exceptions[topMenu.id]) {
        if (topMenu.id === 'houseshield') {
            deactivateHouseshield();
        } else if (topMenu.id === 'floating-menu') {
            closeFloatingMenu();
        } else {
            closeTopMenu();
        }
    }
});

document.addEventListener('click', function(event) {
    if (event.target.closest('.spreadsheet-row .student-name')) {
        const studentName = event.target.closest('.student-name').textContent;
        const student = students.find(s => s.name === studentName);
        if (student) {
            cycleAttendanceForStudent(student);
        }
    }
});

document.addEventListener('keydown', (event) => {
}, true);

window.onload = function() {
    preloadHouseImages();
    currentClassIndex = getCurrentClass();
    updateClassDisplay();
    updateDateTime();
    loadStickyNotes(); // Add this to load sticky notes on page load
    setInterval(updateDateTime, 60000);
    setInterval(() => {
        const newIndex = getCurrentClass();
        if (newIndex !== currentClassIndex) {
            currentClassIndex = newIndex;
            updateClassDisplay();
        }
    }, 1000);
    setInterval(updateCountdowns, 1000);
};

function exportScores() {
    let studentsToExport = students;
    const isMsBandThursday = classes[currentClassIndex].name === "MS Band ·µÄ·¥¥·µÅ·¥øÀ¢";
    
    // For MS Band Thursday, use msBandStudents order and mark non-present students
    if (isMsBandThursday) {
        studentsToExport = msBandStudents.map(student => {
            const thursdayStudent = msBandThursdayStudents.find(s => s.name === student.name);
            if (thursdayStudent) {
                return students.find(s => s.name === student.name) || {
                    ...student,
                    attendance: 'Absent',
                    score: 'EX',
                    stands: false,
                    ipads: false,
                    returned: false,
                    engagement: false,
                    housePoints: 0,
                    manualAdjustment: 0
                };
            } else {
                return {
                    ...student,
                    attendance: 'Absent',
                    score: 'EX',
                    stands: false,
                    ipads: false,
                    returned: false,
                    engagement: false,
                    housePoints: 0,
                    manualAdjustment: 0
                };
            }
        });
    }

    const regularStudents = studentsToExport.filter(s => !s.isAdditional);
    const additionalStudents = studentsToExport.filter(s => s.isAdditional);

    // Create headers and data rows
    const headers = ['Name', ...regularStudents.map(student => `"${student.name}"`)];
    const classworkRow = ['Classwork', ...regularStudents.map(student => `"${student.score === 'EX' ? 'EX' : `${student.score}%`}"`)];

    // Format current date as "MM/DD/YYYY" for DATEVALUE
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/(\d+)\/(\d+)\/(\d+)/, '$1/$2/$3');

    // Add house points section with liveschoolName and + for positive values, sorted alphabetically
    const housePointsItemized = studentsToExport
        .filter(student => student.housePoints !== 0)
        .map(student => {
            const masterStudent = masterList.find(s => s.name === student.name);
            const liveschoolName = masterStudent ? masterStudent.liveschoolName : student.name;
            return { name: liveschoolName, points: student.housePoints };
        })
        .sort((a, b) => a.name.localeCompare(b.name))
        .map(item => `"${item.name}",${item.points > 0 ? '+' : ''}${item.points}`);

    // Add tardies section with DATEVALUE
    const tardiesItemized = (isMsBandThursday ? students : studentsToExport)
        .filter(student => student.attendance === 'Tardy')
        .map(student => `"${student.name}",Tardy,=DATEVALUE("${dateStr}")`);

    // Add absences section with DATEVALUE
    const absencesItemized = (isMsBandThursday ? students : studentsToExport)
        .filter(student => student.attendance === 'Absent')
        .map(student => `"${student.name}",Absent,=DATEVALUE("${dateStr}")`);

    // Add additional students section
    const additionalStudentsMessage = additionalStudents.length > 0
        ? additionalStudents.map(s => `"${s.name}",Additional`)
        : [];

    // Combine all sections with empty rows before labels
    const finalCsvRows = [
        headers.join(','),
        classworkRow.join(','),
        ...(housePointsItemized.length > 0 ? ['', 'House Points', ...housePointsItemized] : []),
        ...(tardiesItemized.length > 0 ? ['', 'Tardies', ...tardiesItemized] : []),
        ...(absencesItemized.length > 0 ? ['', 'Absences', ...absencesItemized] : []),
        ...(additionalStudentsMessage.length > 0 ? additionalStudentsMessage : [])
    ];

    // Generate and download CSV
    const csvFileDateStr = now.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
    const className = classes[currentClassIndex].name.replace(/[^a-zA-Z0-9]/g, '_');
    const csvContent = finalCsvRows.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `${className}_Scores_${csvFileDateStr}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);

    // Prepare alert message
    const housePointsDisplay = housePointsItemized.length > 0 
        ? housePointsItemized.map(item => {
            const [name, points] = item.split(',');
            return `${name.replace(/"/g, '')}: ${points}`;
        }).join('\n')
        : 'No house points';
    const tardiesDisplay = tardiesItemized.length > 0 
        ? `Tardies:\n${tardiesItemized.map(item => {
            const [name] = item.split(',');
            return `${name.replace(/"/g, '')}`;
        }).join('\n')}`
        : 'No tardies';
    const absencesDisplay = absencesItemized.length > 0 
        ? `Absences:\n${absencesItemized.map(item => {
            const [name] = item.split(',');
            return `${name.replace(/"/g, '')}`;
        }).join('\n')}`
        : 'No absences';
    const separator = housePointsItemized.length === 0 && tardiesItemized.length === 0 && absencesItemized.length === 0 ? '\n' : '\n\n';
    const message = `House points for today:\n${housePointsDisplay}${separator}${tardiesDisplay}\n\n${absencesDisplay}${additionalStudentsMessage.length > 0 ? `\n\nAdditional students:\n${additionalStudents.map(s => s.name).join('\n')}` : ''}\n\nReset scores?`;

    showCustomAlert(message);
    showTemporaryMessage('Scores exported as CSV');
    closeSpecificMenu('teacher-mode');
}

function showCustomAlert(message) {
    const alertOverlay = document.createElement('div');
    alertOverlay.id = 'alert-overlay';
    alertOverlay.style.position = 'fixed';
    alertOverlay.style.top = '0';
    alertOverlay.style.left = '0';
    alertOverlay.style.width = '100%';
    alertOverlay.style.height = '100%';
    alertOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
    alertOverlay.style.display = 'flex';
    alertOverlay.style.justifyContent = 'center';
    alertOverlay.style.alignItems = 'center';
    alertOverlay.style.zIndex = '9999';

    const alertBox = document.createElement('div');
    alertBox.style.backgroundColor = 'white';
    alertBox.style.padding = '20px';
    alertBox.style.borderRadius = '5px';
    alertBox.style.maxWidth = '80%';
    alertBox.style.maxHeight = '80%';
    alertBox.style.overflow = 'auto';
    alertBox.style.position = 'relative';
    alertBox.style.transition = 'transform 0.3s ease-in-out';
    alertBox.style.transform = 'scale(0.8)';
    setTimeout(() => {
        alertBox.style.transform = 'scale(1)';
    }, 10);

    const messageElement = document.createElement('pre');
    messageElement.textContent = message;
    messageElement.style.whiteSpace = 'pre-wrap';
    messageElement.style.wordBreak = 'break-word';

    const okButton = document.createElement('button');
    okButton.textContent = 'OK';
    okButton.style.marginTop = '10px';
    okButton.style.marginRight = '10px';
    okButton.onclick = () => {
        resetAllStudents();
        closeAlert();
    };

    const closeButton = document.createElement('button');
    closeButton.textContent = '√ó';
    closeButton.style.position = 'absolute';
    closeButton.style.top = '10px';
    closeButton.style.right = '10px';
    closeButton.style.background = 'none';
    closeButton.style.border = 'none';
    closeButton.style.fontSize = '20px';
    closeButton.style.cursor = 'pointer';
    closeButton.onclick = closeAlert;

    alertBox.appendChild(closeButton);
    alertBox.appendChild(messageElement);
    alertBox.appendChild(okButton);
    alertOverlay.appendChild(alertBox);
    document.body.appendChild(alertOverlay);
}

function closeAlert() {
    const alertOverlay = document.getElementById('alert-overlay');
    if (alertOverlay) {
        const alertBox = alertOverlay.querySelector('div');
        alertBox.style.transform = 'scale(0.8)';
        alertBox.style.opacity = '0';
        setTimeout(() => {
            document.body.removeChild(alertOverlay);
        }, 300);
    }
}

function showTemporaryMessage(message) {
    const messageElement = document.createElement('div');
    messageElement.textContent = message;
    messageElement.style.position = 'fixed';
    messageElement.style.bottom = '20px';
    messageElement.style.left = '50%';
    messageElement.style.transform = 'translateX(-50%)';
    messageElement.style.backgroundColor = '#4CAF50';
    messageElement.style.color = 'white';
    messageElement.style.padding = '10px 20px';
    messageElement.style.borderRadius = '5px';
    messageElement.style.zIndex = '5000';
    messageElement.style.opacity = '1';
    messageElement.style.transition = 'opacity 1s ease-in-out';
    document.body.appendChild(messageElement);

    setTimeout(() => {
        messageElement.style.opacity = '0';
        setTimeout(() => {
            document.body.removeChild(messageElement);
        }, 1000);
    }, 1000);
}

function resetAllStudents() {
    students.forEach(student => {
        student.attendance = 'Absent';
        student.stands = false;
        student.ipads = false;
        student.devices = false;
        student.review = false;
        student.returned = false;
        student.progress = false;
        student.engagement = false;
        student.score = 'EX';
        student.housePoints = 0;
        updateScoreDisplay(student);
    });

    document.querySelectorAll('.attendance-dropdown select').forEach(select => {
        select.value = 'Absent';
    });

    document.querySelectorAll('.checkbox-container input[type="checkbox"]').forEach(checkbox => {
        checkbox.checked = false;
    });

    document.querySelectorAll('.spreadsheet-row .stepper:last-child span').forEach(span => {
        span.textContent = '0';
    });

    const bars = document.querySelectorAll('.bar');
    bars.forEach(bar => {
        bar.style.transition = 'height 0.5s ease-in-out, width 0.5s ease-in-out';
        bar.style.height = '0px';
    });
    setTimeout(() => {
        createBars();
    }, 500);
}

createBars();
updateDateTime();
setInterval(updateDateTime, 1000);
    </script>
</body>
</html>